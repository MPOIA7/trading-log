<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ping Pong Mobile - Online</title>
    <style>
        /* ===== CONSTANTS & VARIABLES ===== */
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --bg-color: #f0f0f3;
            --text-color: #333;
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --shadow-light: #ffffff;
            --shadow-dark: #d1d1d1;
            --paddle-color: #667eea;
            --ball-color: #764ba2;
            --ui-bg: #f0f0f3;
            --button-bg: #e0e0e0;
            --button-text: #333;
            --border-radius: 20px;
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --bg-color: #0f0f1e;
            --text-color: #f0f0f3;
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --shadow-light: #2a2a3e;
            --shadow-dark: #000000;
            --paddle-color: #667eea;
            --ball-color: #764ba2;
            --ui-bg: #1a1a2e;
            --button-bg: #2a2a3e;
            --button-text: #f0f0f3;
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* ===== SCREENS ===== */
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }

        /* ===== MAIN MENU ===== */
        .main-menu {
            text-align: center;
        }

        .logo {
            font-size: clamp(3rem, 10vw, 6rem);
            font-weight: bold;
            margin-bottom: 2rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 300px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            background: var(--button-bg);
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: 
                5px 5px 10px var(--shadow-dark),
                -5px -5px 10px var(--shadow-light);
            color: var(--button-text);
            font-weight: 600;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            box-shadow: 
                inset 3px 3px 6px var(--shadow-dark),
                inset -3px -3px 6px var(--shadow-light);
            transform: scale(0.98);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-left: 8px;
        }

        /* ===== GAME SCREEN ===== */
        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .game-header {
            background: var(--ui-bg);
            padding: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .score-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
        }

        .match-score {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0.3rem 0.8rem;
            background: var(--button-bg);
            border-radius: 8px;
            box-shadow: 
                2px 2px 4px var(--shadow-dark),
                -2px -2px 4px var(--shadow-light);
        }

        .wins-score {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .game-controls {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--button-bg);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                3px 3px 6px var(--shadow-dark),
                -3px -3px 6px var(--shadow-light);
            transition: all var(--transition-speed) ease;
        }

        .icon-btn:active {
            box-shadow: 
                inset 2px 2px 4px var(--shadow-dark),
                inset -2px -2px 4px var(--shadow-light);
        }

        #gameCanvas {
            flex: 1;
            width: 100%;
            touch-action: none;
            cursor: pointer;
        }

        /* ===== ONLINE LOBBY ===== */
        .online-lobby {
            background: var(--ui-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
            text-align: center;
        }

        .lobby-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }

        .room-code-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--button-bg);
            border-radius: var(--border-radius);
            box-shadow: 
                inset 2px 2px 4px var(--shadow-dark),
                inset -2px -2px 4px var(--shadow-light);
        }

        .room-code {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            letter-spacing: 0.5rem;
        }

        .room-code-label {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        .join-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            text-align: center;
            border-radius: var(--border-radius);
            border: none;
            background: var(--button-bg);
            box-shadow: 
                inset 2px 2px 4px var(--shadow-dark),
                inset -2px -2px 4px var(--shadow-light);
            margin: 1rem 0;
            letter-spacing: 0.3rem;
        }

        .status-message {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: var(--border-radius);
            color: var(--primary-color);
        }

        .player-list {
            margin: 1rem 0;
            text-align: right;
        }

        .player-item {
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            background: var(--button-bg);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
        }

        .player-status.waiting {
            background: #ff9800;
        }

        /* ===== SETTINGS SCREEN ===== */
        .settings-container {
            background: var(--ui-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 
                10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
            overflow-y: auto;
            max-height: 80vh;
        }

        .settings-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .setting-control {
            width: 100%;
            padding: 0.5rem;
            border-radius: 10px;
            border: none;
            background: var(--button-bg);
            box-shadow: 
                inset 2px 2px 4px var(--shadow-dark),
                inset -2px -2px 4px var(--shadow-light);
            color: var(--button-text);
            font-size: 1rem;
        }

        .toggle-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .toggle-btn {
            flex: 1;
            min-width: 80px;
            padding: 0.5rem;
            border-radius: 10px;
            border: none;
            background: var(--button-bg);
            box-shadow: 
                3px 3px 6px var(--shadow-dark),
                -3px -3px 6px var(--shadow-light);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            color: var(--button-text);
        }

        .toggle-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* ===== HOW TO PLAY ===== */
        .howto-container {
            background: var(--ui-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
        }

        .howto-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .howto-section {
            margin-bottom: 1.5rem;
        }

        .howto-section h3 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .howto-section p {
            line-height: 1.6;
        }

        /* ===== GAME MODE SELECTION ===== */
        .mode-selection {
            background: var(--ui-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 
                10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
            text-align: center;
        }

        .mode-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* ===== VICTORY SCREEN ===== */
        .victory-container {
            background: var(--ui-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 
                10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
            text-align: center;
        }

        .victory-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .victory-message {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .victory-score {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            font-weight: bold;
        }

        /* ===== TOAST/HINT ===== */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--ui-bg);
            padding: 1rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: 
                5px 5px 10px var(--shadow-dark),
                -5px -5px 10px var(--shadow-light);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== FPS COUNTER ===== */
        .fps-counter {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            display: none;
        }

        .fps-counter.show {
            display: block;
        }

        /* ===== LOADING SPINNER ===== */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--button-bg);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .settings-container,
            .howto-container,
            .mode-selection,
            .victory-container,
            .online-lobby {
                padding: 1.5rem;
            }
            
            .logo {
                font-size: 3rem;
            }
            
            .btn {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            
            .room-code {
                font-size: 1.5rem;
                letter-spacing: 0.2rem;
            }
        }

        /* ===== ACCESSIBILITY ===== */
        button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Main Menu Screen -->
    <div id="mainMenu" class="screen active">
        <div class="main-menu">
            <h1 class="logo">PING PONG</h1>
            <div class="menu-buttons">
                <button class="btn" onclick="showScreen('modeSelection')" aria-label="ابدأ اللعبة">
                    Play
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                <button class="btn" onclick="showScreen('onlineLobby')" aria-label="العب أونلاين">
                    Play Online
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </button>
                <button class="btn" onclick="showScreen('settings')" aria-label="الإعدادات">
                    Settings
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m-7-3.5a7 7 0 0 0 7 7a7 7 0 0 0 7-7a7 7 0 0 0-7-7a7 7 0 0 0-7 7M12 2l1.39 1.39L12 4.78L10.61 3.39L12 2m0 19.22l1.39-1.39L12 18.61l-1.39 1.39L12 21.22M2 12l1.39-1.39L4.78 12l-1.39 1.39L2 12m19.22 0l-1.39 1.39L18.61 12l1.39-1.39L21.22 12M5.64 5.64l1.39 1.39L5.64 8.42L4.25 7.03L5.64 5.64m12.72 12.72l-1.39-1.39l1.39-1.39l1.39 1.39l-1.39 1.39M8.42 5.64L7.03 7.03l1.39 1.39l1.39-1.39L8.42 5.64m7.16 12.72l1.39-1.39l-1.39-1.39l-1.39 1.39l1.39 1.39z"/>
                    </svg>
                </button>
                <button class="btn" onclick="showScreen('howToPlay')" aria-label="كيفية اللعب">
                    How to Play
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11 9h2V7h-2m1 13c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8m0-18C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m-1 15h2v-6h-2v6z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Game Mode Selection -->
    <div id="modeSelection" class="screen">
        <div class="mode-selection">
            <h2 class="mode-title">اختر وضع اللعب</h2>
            <div class="mode-buttons">
                <button class="btn" onclick="startGame('single')" aria-label="لعب ضد الكمبيوتر">
                    Single Player (vs AI)
                </button>
                <button class="btn" onclick="startGame('two')" aria-label="لعب لاعبين">
                    Two Players
                </button>
                <button class="btn" onclick="showScreen('mainMenu')" aria-label="العودة للقائمة الرئيسية">
                    Back
                </button>
            </div>
        </div>
    </div>

    <!-- Online Lobby Screen -->
    <div id="onlineLobby" class="screen">
        <div class="online-lobby">
            <h2 class="lobby-title">العب مع الأصدقاء</h2>
            
            <div id="createRoomSection">
                <button class="btn" onclick="createRoom()" aria-label="إنشاء غرفة">
                    إنشاء غرفة جديدة
                </button>
                
                <div class="room-code-container" id="roomCodeContainer" style="display: none;">
                    <div class="room-code-label">كود الغرفة:</div>
                    <div class="room-code" id="roomCode">------</div>
                    <button class="btn" onclick="copyRoomCode()" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        نسخ الكود
                    </button>
                </div>
            </div>
            
            <div style="margin: 2rem 0; font-size: 1.2rem; opacity: 0.7;">أو</div>
            
            <div id="joinRoomSection">
                <input type="text" class="join-input" id="joinCodeInput" placeholder="أدخل كود الغرفة" maxlength="6">
                <button class="btn" onclick="joinRoom()" aria-label="انضمام للغرفة">
                    انضمام للغرفة
                </button>
            </div>
            
            <div class="status-message" id="lobbyStatus" style="display: none;"></div>
            
            <div class="player-list" id="playerList" style="display: none;">
                <h3 style="margin-bottom: 1rem;">اللاعبون:</h3>
                <div class="player-item">
                    <span>أنت</span>
                    <span class="player-status"></span>
                </div>
                <div class="player-item" id="opponentPlayer" style="display: none;">
                    <span>الخصم</span>
                    <span class="player-status waiting"></span>
                </div>
            </div>
            
            <div class="spinner" id="lobbySpinner" style="display: none;"></div>
            
            <button class="btn" onclick="showScreen('mainMenu')" style="margin-top: 2rem;">
                العودة للقائمة
            </button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div class="game-container">
            <div class="game-header">
                <div class="score-container">
                    <div class="match-score" id="scoreDisplay">0 : 0</div>
                    <div class="wins-score" id="winsDisplay">الانتصارات: 0 - 0</div>
                </div>
                <div class="game-controls">
                    <button class="icon-btn" id="pauseBtn" onclick="togglePause()" aria-label="إيقاف مؤقت">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 19h4V5h-4m-6 14h4V5H8v14z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" id="soundBtn" onclick="toggleSound()" aria-label="الصوت">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <canvas id="gameCanvas"></canvas>
            <div class="fps-counter" id="fpsCounter">60 FPS</div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings" class="screen">
        <div class="settings-container">
            <h2 class="settings-title">الإعدادات</h2>
            
            <div class="setting-group">
                <label class="setting-label">صعوبة الذكاء الاصطناعي</label>
                <div class="toggle-group">
                    <button class="toggle-btn" onclick="setDifficulty('easy')">سهل</button>
                    <button class="toggle-btn" onclick="setDifficulty('medium')">متوسط</button>
                    <button class="toggle-btn" onclick="setDifficulty('hard')">صعب</button>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">نقاط الفوز في المباراة</label>
                <select class="setting-control" id="winScore" onchange="updateSettings()">
                    <option value="5">5 نقاط</option>
                    <option value="7">7 نقاط</option>
                    <option value="10" selected>10 نقاط</option>
                    <option value="11">11 نقطة</option>
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label">سرعة اللعبة</label>
                <input type="range" class="setting-control" id="gameSpeed" min="0.5" max="2" step="0.1" value="1" onchange="updateSettings()">
            </div>

            <div class="setting-group">
                <label class="setting-label">التفضيلات</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="soundEnabled" onchange="updateSettings()">
                        <span>تفعيل الصوت</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="vibrationEnabled" onchange="updateSettings()">
                        <span>تفعيل الاهتزاز</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="showFps" onchange="updateSettings()">
                        <span>عرض FPS</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="tiltControl" onchange="updateSettings()">
                        <span>التحكم بالإمالة</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="darkMode" onchange="toggleTheme()">
                        <span>الوضع الليلي</span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <button class="btn" onclick="resetSettings()">إعادة التعيين</button>
            </div>

            <button class="btn" onclick="showScreen('mainMenu')">العودة</button>
        </div>
    </div>

    <!-- How to Play Screen -->
    <div id="howToPlay" class="screen">
        <div class="howto-container">
            <h2 class="howto-title">كيفية اللعب</h2>
            
            <div class="howto-section">
                <h3>الهدف</h3>
                <p>اربح 10 مباريات للفوز النهائي! كل مباراة تنتهي عند وصول أحد اللاعبين إلى عدد النقاط المحدد. الفائز في كل مباراة يحصل على نقطة في العداد العام.</p>
            </div>

            <div class="howto-section">
                <h3>اللعب أونلاين</h3>
                <p>1. اضغط على "Play Online"<br>
                2. أنشئ غرفة جديدة وشارك الكود مع صديقك<br>
                3. أو أدخل كود الغرفة التي شاركها صديقك<br>
                4. انتظر حتى ينضم اللاعب الآخر وابدأ اللعب!</p>
            </div>

            <div class="howto-section">
                <h3>على الهاتف</h3>
                <p>اسحب بإصبعك لأعلى أو لأسفل في نصف الشاشة الخاص بك لتحريك المضرب. اللاعب الأيسر يستخدم النصف الأيسر، واللاعب الأيمن يستخدم النصف الأيمن.</p>
            </div>

            <div class="howto-section">
                <h3>على الكمبيوتر</h3>
                <p>استخدم الأسهم ↑ ↓ للتحكم بالمضرب الأيسر، و W/S للتحكم بالمضرب الأيمن.</p>
            </div>

            <div class="howto-section">
                <h3>نصائح</h3>
                <p>• اصطدام الكرة بأطراف المضرب يغير زاويتها<br>
                • تزداد سرعة الكرة تدريجياً مع الوقت<br>
                • يمكنك إيقاف اللعبة مؤقتاً في أي وقت</p>
            </div>

            <button class="btn" onclick="showScreen('mainMenu')">العودة</button>
        </div>
    </div>

    <!-- Victory Screen -->
    <div id="victoryScreen" class="screen">
        <div class="victory-container">
            <h2 class="victory-title" id="victoryTitle">فوز!</h2>
            <div class="victory-message" id="victoryMessage">تهانينا على فوزك!</div>
            <div class="victory-score" id="victoryScore">النتيجة: 0 - 0</div>
            <div class="mode-buttons">
                <button class="btn" id="continueBtn" onclick="continueGame()">متابعة اللعب</button>
                <button class="btn" onclick="showScreen('mainMenu')">القائمة الرئيسية</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // ===== GAME CONSTANTS =====
        const CONSTANTS = {
            PADDLE_WIDTH: 15,
            PADDLE_HEIGHT: 80,
            PADDLE_SPEED: 8,
            BALL_SIZE: 15,
            BALL_SPEED: 5,
            BALL_ACCELERATION: 0.001,
            MAX_BALL_SPEED: 15,
            AI_EASY_SPEED: 6,
            AI_MEDIUM_SPEED: 8,
            AI_HARD_SPEED: 10,
            WIN_SCORES: [5, 7, 10, 11],
            DEFAULT_WIN_SCORE: 10,
            DEFAULT_DIFFICULTY: 'medium',
            DEFAULT_SOUND_ENABLED: true,
            DEFAULT_VIBRATION_ENABLED: true,
            DEFAULT_SHOW_FPS: false,
            DEFAULT_TILT_CONTROL: false,
            DEFAULT_DARK_MODE: false,
            DEFAULT_GAME_SPEED: 1,
            FINAL_WIN_SCORE: 10
        };

        // ===== GAME STATE =====
        let gameState = {
            mode: 'single',
            difficulty: 'easy',
            winScore: CONSTANTS.DEFAULT_WIN_SCORE,
            gameSpeed: CONSTANTS.DEFAULT_GAME_SPEED,
            soundEnabled: CONSTANTS.DEFAULT_SOUND_ENABLED,
            vibrationEnabled: CONSTANTS.DEFAULT_VIBRATION_ENABLED,
            showFps: CONSTANTS.DEFAULT_SHOW_FPS,
            tiltControl: CONSTANTS.DEFAULT_TILT_CONTROL,
            darkMode: CONSTANTS.DEFAULT_DARK_MODE,
            paused: false,
            running: false,
            leftScore: 0,
            rightScore: 0,
            leftWins: 0,
            rightWins: 0,
            lastWinner: null,
            isOnline: false,
            isHost: false,
            roomId: null,
            playerId: null,
            stats: {
                singleWins: 0,
                twoPlayerWins: 0,
                onlineWins: 0
            }
        };

        // ===== ONLINE MULTIPLAYER =====
        class OnlineManager {
            constructor() {
                this.peer = null;
                this.conn = null;
                this.roomId = null;
                this.isHost = false;
                this.onOpponentConnected = null;
                this.onOpponentDisconnected = null;
                this.onGameUpdate = null;
            }

            async init() {
                // Load PeerJS library dynamically
                if (!window.Peer) {
                    await this.loadPeerJS();
                }
                
                // Create a new peer with a random ID
                this.peer = new Peer();
                
                this.peer.on('open', (id) => {
                    console.log('My peer ID is:', id);
                    gameState.playerId = id;
                });
                
                this.peer.on('connection', (conn) => {
                    this.handleConnection(conn);
                });
                
                this.peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    showToast('خطأ في الاتصال');
                });
            }

            async loadPeerJS() {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            createRoom() {
                this.roomId = this.generateRoomCode();
                this.isHost = true;
                gameState.roomId = this.roomId;
                gameState.isHost = true;
                
                // Show room code
                document.getElementById('roomCode').textContent = this.roomId;
                document.getElementById('roomCodeContainer').style.display = 'block';
                document.getElementById('lobbyStatus').style.display = 'block';
                document.getElementById('lobbyStatus').textContent = 'في انتظار انضمام لاعب آخر...';
                document.getElementById('lobbySpinner').style.display = 'block';
                document.getElementById('playerList').style.display = 'block';
                
                showToast('تم إنشاء الغرفة بنجاح');
            }

            joinRoom(roomId) {
                this.roomId = roomId;
                this.isHost = false;
                gameState.roomId = roomId;
                gameState.isHost = false;
                
                // Connect to host
                const conn = this.peer.connect(roomId);
                this.handleConnection(conn);
                
                document.getElementById('lobbyStatus').style.display = 'block';
                document.getElementById('lobbyStatus').textContent = 'جاري الاتصال بالغرفة...';
                document.getElementById('lobbySpinner').style.display = 'block';
                document.getElementById('playerList').style.display = 'block';
            }

            handleConnection(conn) {
                this.conn = conn;
                
                conn.on('open', () => {
                    console.log('Connected to peer!');
                    document.getElementById('lobbyStatus').textContent = 'تم الاتصال! جاري بدء اللعبة...';
                    document.getElementById('opponentPlayer').style.display = 'flex';
                    document.querySelector('#opponentPlayer .player-status').classList.remove('waiting');
                    
                    if (this.onOpponentConnected) {
                        this.onOpponentConnected();
                    }
                    
                    // Start game after a short delay
                    setTimeout(() => {
                        startOnlineGame();
                    }, 1500);
                });
                
                conn.on('data', (data) => {
                    this.handleGameData(data);
                });
                
                conn.on('close', () => {
                    console.log('Connection closed');
                    if (this.onOpponentDisconnected) {
                        this.onOpponentDisconnected();
                    }
                });
                
                conn.on('error', (err) => {
                    console.error('Connection error:', err);
                    showToast('خطأ في الاتصال بالخصم');
                });
            }

            sendGameData(data) {
                if (this.conn && this.conn.open) {
                    this.conn.send(data);
                }
            }

            handleGameData(data) {
                if (this.onGameUpdate) {
                    this.onGameUpdate(data);
                }
            }

            generateRoomCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            }

            disconnect() {
                if (this.conn) {
                    this.conn.close();
                }
                if (this.peer) {
                    this.peer.destroy();
                }
            }
        }

        // ===== CANVAS SETUP =====
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let canvasWidth, canvasHeight;

        // ===== GAME OBJECTS =====
        class Paddle {
            constructor(x, y, isLeft = true) {
                this.x = x;
                this.y = y;
                this.width = CONSTANTS.PADDLE_WIDTH;
                this.height = CONSTANTS.PADDLE_HEIGHT;
                this.speed = CONSTANTS.PADDLE_SPEED;
                this.isLeft = isLeft;
                this.targetY = y;
            }

            update() {
                const diff = this.targetY - this.y;
                this.y += diff * 0.3;
                this.y = Math.max(0, Math.min(canvasHeight - this.height, this.y));
            }

            draw() {
                ctx.fillStyle = gameState.darkMode ? '#667eea' : '#764ba2';
                ctx.shadowBlur = 10;
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.shadowBlur = 0;
            }

            moveTo(y) {
                this.targetY = y - this.height / 2;
            }

            getState() {
                return {
                    x: this.x,
                    y: this.y,
                    targetY: this.targetY
                };
            }

            setState(state) {
                this.x = state.x;
                this.y = state.y;
                this.targetY = state.targetY;
            }
        }

        class Ball {
            constructor() {
                this.reset();
                this.size = CONSTANTS.BALL_SIZE;
                this.speed = CONSTANTS.BALL_SPEED;
                this.acceleration = CONSTANTS.BALL_ACCELERATION;
            }

            reset() {
                this.x = canvasWidth / 2;
                this.y = canvasHeight / 2;
                this.vx = (Math.random() > 0.5 ? 1 : -1) * this.speed;
                this.vy = (Math.random() - 0.5) * this.speed;
                this.speed = CONSTANTS.BALL_SPEED;
            }

            update() {
                this.x += this.vx * gameState.gameSpeed;
                this.y += this.vy * gameState.gameSpeed;
                this.speed = Math.min(this.speed + this.acceleration, CONSTANTS.MAX_BALL_SPEED);

                if (this.y - this.size/2 <= 0 || this.y + this.size/2 >= canvasHeight) {
                    this.vy = -this.vy;
                    playSound('wall');
                }

                if (this.checkPaddleCollision(leftPaddle) || this.checkPaddleCollision(rightPaddle)) {
                    playSound('paddle');
                }

                if (this.x < 0) {
                    gameState.rightScore++;
                    this.onScore('right');
                } else if (this.x > canvasWidth) {
                    gameState.leftScore++;
                    this.onScore('left');
                }
            }

            checkPaddleCollision(paddle) {
                if (this.x - this.size/2 < paddle.x + paddle.width &&
                    this.x + this.size/2 > paddle.x &&
                    this.y - this.size/2 < paddle.y + paddle.height &&
                    this.y + this.size/2 > paddle.y) {
                    
                    const hitPos = (this.y - paddle.y) / paddle.height;
                    const angle = (hitPos - 0.5) * Math.PI / 3;
                    const direction = paddle.isLeft ? 1 : -1;
                    this.vx = Math.cos(angle) * this.speed * direction;
                    this.vy = Math.sin(angle) * this.speed;
                    
                    if (paddle.isLeft) {
                        this.x = paddle.x + paddle.width + this.size/2;
                    } else {
                        this.x = paddle.x - this.size/2;
                    }
                    
                    return true;
                }
                return false;
            }

            onScore(winner) {
                gameState.lastWinner = winner;
                updateScoreDisplay();
                updateWinsDisplay();
                
                if (gameState.vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate(100);
                }
                
                playSound('score');
                
                if (gameState.leftScore >= gameState.winScore || gameState.rightScore >= gameState.winScore) {
                    endMatch();
                } else {
                    showToast(`${winner === 'left' ? 'اللاعب الأيسر' : 'اللاعب الأيمن'} سجل نقطة!`);
                    setTimeout(() => this.reset(), 1000);
                }
            }

            draw() {
                ctx.fillStyle = gameState.darkMode ? '#764ba2' : '#667eea';
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size/2, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            getState() {
                return {
                    x: this.x,
                    y: this.y,
                    vx: this.vx,
                    vy: this.vy,
                    speed: this.speed
                };
            }

            setState(state) {
                this.x = state.x;
                this.y = state.y;
                this.vx = state.vx;
                this.vy = state.vy;
                this.speed = state.speed;
            }
        }

        class AI {
            constructor(paddle, difficulty) {
                this.paddle = paddle;
                this.difficulty = difficulty;
                this.speed = this.getSpeed();
                this.errorMargin = this.getErrorMargin();
                this.predictionAccuracy = this.getPredictionAccuracy();
            }

            getSpeed() {
                switch(this.difficulty) {
                    case 'easy': return CONSTANTS.AI_EASY_SPEED;
                    case 'medium': return CONSTANTS.AI_MEDIUM_SPEED;
                    case 'hard': return CONSTANTS.AI_HARD_SPEED;
                    default: return CONSTANTS.AI_MEDIUM_SPEED;
                }
            }

            getErrorMargin() {
                switch(this.difficulty) {
                    case 'easy': return 40;
                    case 'medium': return 25;
                    case 'hard': return 15;
                    default: return 25;
                }
            }

            getPredictionAccuracy() {
                switch(this.difficulty) {
                    case 'easy': return 0.5;
                    case 'medium': return 0.7;
                    case 'hard': return 0.85;
                    default: return 0.7;
                }
            }

            update(ball) {
                let targetY = ball.y;
                
                if (Math.random() < this.predictionAccuracy) {
                    const timeToReach = Math.abs((this.paddle.x - ball.x) / ball.vx);
                    let predictedY = ball.y + ball.vy * timeToReach;
                    
                    if (this.difficulty !== 'easy') {
                        while (predictedY < 0 || predictedY > canvasHeight) {
                            if (predictedY < 0) predictedY = -predictedY;
                            if (predictedY > canvasHeight) predictedY = 2 * canvasHeight - predictedY;
                        }
                    }
                    
                    targetY = predictedY;
                }
                
                targetY += (Math.random() - 0.5) * this.errorMargin;
                
                const currentY = this.paddle.y + this.paddle.height / 2;
                const diff = targetY - currentY;
                
                if (Math.abs(diff) > this.speed) {
                    this.paddle.moveTo(currentY + Math.sign(diff) * this.speed);
                } else {
                    this.paddle.moveTo(targetY);
                }
            }
        }

        // ===== INPUT HANDLING =====
        class Input {
            constructor() {
                this.touches = new Map();
                this.keys = {};
                this.tilt = 0;
                this.setupEventListeners();
            }

            setupEventListeners() {
                canvas.addEventListener('touchstart', this.handleTouchStart.bind(this));
                canvas.addEventListener('touchmove', this.handleTouchMove.bind(this));
                canvas.addEventListener('touchend', this.handleTouchEnd.bind(this));
                
                canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
                canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
                canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));
                
                window.addEventListener('keydown', this.handleKeyDown.bind(this));
                window.addEventListener('keyup', this.handleKeyUp.bind(this));
                
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', this.handleOrientation.bind(this));
                }
            }

            handleTouchStart(e) {
                e.preventDefault();
                for (let touch of e.changedTouches) {
                    this.touches.set(touch.identifier, {
                        x: touch.clientX,
                        y: touch.clientY,
                        startY: touch.clientY
                    });
                }
            }

            handleTouchMove(e) {
                e.preventDefault();
                for (let touch of e.changedTouches) {
                    const touchData = this.touches.get(touch.identifier);
                    if (touchData) {
                        touchData.x = touch.clientX;
                        touchData.y = touch.clientY;
                    }
                }
            }

            handleTouchEnd(e) {
                e.preventDefault();
                for (let touch of e.changedTouches) {
                    this.touches.delete(touch.identifier);
                }
            }

            handleMouseDown(e) {
                this.touches.set('mouse', {
                    x: e.clientX,
                    y: e.clientY,
                    startY: e.clientY
                });
            }

            handleMouseMove(e) {
                const touchData = this.touches.get('mouse');
                if (touchData) {
                    touchData.x = e.clientX;
                    touchData.y = e.clientY;
                }
            }

            handleMouseUp(e) {
                this.touches.delete('mouse');
            }

            handleKeyDown(e) {
                this.keys[e.key] = true;
            }

            handleKeyUp(e) {
                this.keys[e.key] = false;
            }

            handleOrientation(e) {
                if (gameState.tiltControl) {
                    this.tilt = e.gamma || 0;
                }
            }

            update() {
                // In online mode, only control local paddle
                if (gameState.isOnline) {
                    const isLeftPaddle = gameState.isHost;
                    
                    this.touches.forEach((touch, id) => {
                        const rect = canvas.getBoundingClientRect();
                        const x = touch.x - rect.left;
                        const y = touch.y - rect.top;
                        
                        if ((isLeftPaddle && x < canvasWidth / 2) || (!isLeftPaddle && x > canvasWidth / 2)) {
                            if (isLeftPaddle) {
                                leftPaddle.moveTo(y);
                            } else {
                                rightPaddle.moveTo(y);
                            }
                        }
                    });

                    if (isLeftPaddle) {
                        if (this.keys['ArrowUp']) leftPaddle.moveTo(leftPaddle.y - leftPaddle.speed);
                        if (this.keys['ArrowDown']) leftPaddle.moveTo(leftPaddle.y + leftPaddle.speed);
                    } else {
                        if (this.keys['w'] || this.keys['W']) rightPaddle.moveTo(rightPaddle.y - rightPaddle.speed);
                        if (this.keys['s'] || this.keys['S']) rightPaddle.moveTo(rightPaddle.y + rightPaddle.speed);
                    }
                } else {
                    // Local multiplayer
                    this.touches.forEach((touch, id) => {
                        const rect = canvas.getBoundingClientRect();
                        const x = touch.x - rect.left;
                        const y = touch.y - rect.top;
                        
                        if (gameState.mode === 'two' || x < canvasWidth / 2) {
                            leftPaddle.moveTo(y);
                        } else if (gameState.mode === 'two') {
                            rightPaddle.moveTo(y);
                        }
                    });

                    if (this.keys['ArrowUp']) leftPaddle.moveTo(leftPaddle.y - leftPaddle.speed);
                    if (this.keys['ArrowDown']) leftPaddle.moveTo(leftPaddle.y + leftPaddle.speed);
                    if (this.keys['w'] || this.keys['W']) rightPaddle.moveTo(rightPaddle.y - rightPaddle.speed);
                    if (this.keys['s'] || this.keys['S']) rightPaddle.moveTo(rightPaddle.y + rightPaddle.speed);
                }

                if (gameState.tiltControl && gameState.mode === 'single') {
                    const tiltAmount = this.tilt / 90;
                    const targetY = canvasHeight / 2 + (tiltAmount * canvasHeight / 3);
                    leftPaddle.moveTo(targetY);
                }
            }
        }

        // ===== AUDIO =====
        class Audio {
            constructor() {
                this.context = null;
                this.init();
            }

            init() {
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.context = new AudioContext();
                } catch (e) {
                    console.log('Web Audio API not supported');
                }
            }

            playSound(type) {
                if (!gameState.soundEnabled || !this.context) return;

                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);

                switch(type) {
                    case 'paddle':
                        oscillator.frequency.value = 440;
                        gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.1);
                        break;
                    case 'wall':
                        oscillator.frequency.value = 220;
                        gainNode.gain.setValueAtTime(0.2, this.context.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.1);
                        break;
                    case 'score':
                        oscillator.frequency.value = 880;
                        gainNode.gain.setValueAtTime(0.4, this.context.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);
                        break;
                }

                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.3);
            }
        }

        // ===== STORAGE =====
        class Storage {
            static save() {
                const data = {
                    settings: {
                        difficulty: gameState.difficulty,
                        winScore: gameState.winScore,
                        gameSpeed: gameState.gameSpeed,
                        soundEnabled: gameState.soundEnabled,
                        vibrationEnabled: gameState.vibrationEnabled,
                        showFps: gameState.showFps,
                        tiltControl: gameState.tiltControl,
                        darkMode: gameState.darkMode
                    },
                    stats: gameState.stats
                };
                localStorage.setItem('pingPongData', JSON.stringify(data));
            }

            static load() {
                const data = localStorage.getItem('pingPongData');
                if (data) {
                    const parsed = JSON.parse(data);
                    
                    if (parsed.settings) {
                        Object.assign(gameState, parsed.settings);
                    }
                    
                    if (parsed.stats) {
                        gameState.stats = parsed.stats;
                    }
                    
                    applySettings();
                }
            }
        }

        // ===== INITIALIZATION =====
        let leftPaddle, rightPaddle, ball, ai, input, audio, onlineManager;
        let lastTime = 0;
        let fps = 60;
        let frameCount = 0;
        let fpsTime = 0;
        let lastSyncTime = 0;

        async function init() {
            Storage.load();
            
            // Initialize online manager
            onlineManager = new OnlineManager();
            onlineManager.onOpponentConnected = () => {
                showToast('تم الاتصال بالخصم!');
            };
            onlineManager.onOpponentDisconnected = () => {
                showToast('انقطع اتصال الخصم');
                endGame();
            };
            onlineManager.onGameUpdate = (data) => {
                handleOnlineUpdate(data);
            };
            
            await onlineManager.init();
            
            resizeCanvas();
            leftPaddle = new Paddle(30, canvasHeight / 2 - CONSTANTS.PADDLE_HEIGHT / 2, true);
            rightPaddle = new Paddle(canvasWidth - 30 - CONSTANTS.PADDLE_WIDTH, canvasHeight / 2 - CONSTANTS.PADDLE_HEIGHT / 2, false);
            ball = new Ball();
            input = new Input();
            audio = new Audio();
            
            ai = new AI(rightPaddle, gameState.difficulty);
            
            updateScoreDisplay();
            updateWinsDisplay();
            updateSoundButton();
            
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvasWidth = container.clientWidth;
            canvasHeight = container.clientHeight - 60;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            if (leftPaddle && rightPaddle) {
                leftPaddle.x = 30;
                rightPaddle.x = canvasWidth - 30 - CONSTANTS.PADDLE_WIDTH;
            }
        }

        // ===== GAME LOOP =====
        function gameLoop(currentTime) {
            if (!gameState.running) return;
            
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            frameCount++;
            fpsTime += deltaTime;
            if (fpsTime >= 1000) {
                fps = Math.round(frameCount * 1000 / fpsTime);
                frameCount = 0;
                fpsTime = 0;
                if (gameState.showFps) {
                    document.getElementById('fpsCounter').textContent = `${fps} FPS`;
                }
            }
            
            if (!gameState.paused) {
                input.update();
                
                leftPaddle.update();
                rightPaddle.update();
                ball.update();
                
                if (gameState.mode === 'single') {
                    ai.update(ball);
                }
                
                // Sync game state in online mode
                if (gameState.isOnline && currentTime - lastSyncTime > 50) {
                    syncGameState();
                    lastSyncTime = currentTime;
                }
            }
            
            render();
            requestAnimationFrame(gameLoop);
        }

        function render() {
            ctx.fillStyle = gameState.darkMode ? '#0f0f1e' : '#f0f0f3';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            ctx.strokeStyle = gameState.darkMode ? '#2a2a3e' : '#d1d1d1';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(canvasWidth / 2, 0);
            ctx.lineTo(canvasWidth / 2, canvasHeight);
            ctx.stroke();
            ctx.setLineDash([]);
            
            leftPaddle.draw();
            rightPaddle.draw();
            ball.draw();
            
            if (gameState.paused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PAUSED', canvasWidth / 2, canvasHeight / 2);
            }
        }

        // ===== ONLINE MULTIPLAYER FUNCTIONS =====
        function createRoom() {
            onlineManager.createRoom();
        }

        function joinRoom() {
            const code = document.getElementById('joinCodeInput').value.toUpperCase();
            if (code.length === 6) {
                onlineManager.joinRoom(code);
            } else {
                showToast('يرجى إدخال كود غرفة صحيح');
            }
        }

        function copyRoomCode() {
            const code = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('تم نسخ الكود!');
            });
        }

        function startOnlineGame() {
            gameState.mode = 'online';
            gameState.isOnline = true;
            gameState.leftScore = 0;
            gameState.rightScore = 0;
            gameState.leftWins = 0;
            gameState.rightWins = 0;
            gameState.paused = false;
            gameState.running = true;
            
            ball.reset();
            
            showScreen('gameScreen');
            
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            
            showToast('بدأت اللعبة الأونلاين!');
        }

        function syncGameState() {
            if (!gameState.isOnline) return;
            
            const gameData = {
                type: 'gameUpdate',
                leftPaddle: leftPaddle.getState(),
                rightPaddle: rightPaddle.getState(),
                ball: ball.getState(),
                leftScore: gameState.leftScore,
                rightScore: gameState.rightScore,
                leftWins: gameState.leftWins,
                rightWins: gameState.rightWins
            };
            
            onlineManager.sendGameData(gameData);
        }

        function handleOnlineUpdate(data) {
            if (data.type === 'gameUpdate') {
                // Update opponent's paddle
                if (gameState.isHost) {
                    rightPaddle.setState(data.rightPaddle);
                } else {
                    leftPaddle.setState(data.leftPaddle);
                }
                
                // Update scores
                gameState.leftScore = data.leftScore;
                gameState.rightScore = data.rightScore;
                gameState.leftWins = data.leftWins;
                gameState.rightWins = data.rightWins;
                
                updateScoreDisplay();
                updateWinsDisplay();
            }
        }

        // ===== GAME CONTROL =====
        function startGame(mode) {
            gameState.mode = mode;
            gameState.isOnline = false;
            gameState.leftScore = 0;
            gameState.rightScore = 0;
            gameState.leftWins = 0;
            gameState.rightWins = 0;
            gameState.paused = false;
            gameState.running = true;
            
            ball.reset();
            
            showScreen('gameScreen');
            
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            
            showToast(`بدأت اللعبة في وضع ${mode === 'single' ? 'اللاعب الواحد' : 'لاعبين'}`);
        }

        function endMatch() {
            gameState.running = false;
            
            if (gameState.leftScore > gameState.rightScore) {
                gameState.leftWins++;
                if (gameState.mode === 'single') {
                    gameState.stats.singleWins++;
                } else if (gameState.mode === 'online') {
                    gameState.stats.onlineWins++;
                }
            } else {
                gameState.rightWins++;
            }
            
            Storage.save();
            
            if (gameState.leftWins >= CONSTANTS.FINAL_WIN_SCORE || gameState.rightWins >= CONSTANTS.FINAL_WIN_SCORE) {
                showFinalVictory();
            } else {
                showMatchVictory();
            }
        }

        function showMatchVictory() {
            const victoryTitle = document.getElementById('victoryTitle');
            const victoryMessage = document.getElementById('victoryMessage');
            const victoryScore = document.getElementById('victoryScore');
            const continueBtn = document.getElementById('continueBtn');
            
            victoryScore.textContent = `نتيجة المباراة: ${gameState.leftScore} - ${gameState.rightScore}`;
            continueBtn.textContent = 'متابعة اللعب';
            continueBtn.onclick = continueGame;
            
            if (gameState.leftScore > gameState.rightScore) {
                victoryTitle.textContent = 'فوز بالمباراة!';
                if (gameState.mode === 'single') {
                    victoryMessage.textContent = `أحسنت! لقد فزت بهذه المباراة! (${gameState.leftWins} - ${gameState.rightWins}) 🎉`;
                } else if (gameState.mode === 'online') {
                    victoryMessage.textContent = `أحسنت! لقد فزت بهذه المباراة! (${gameState.leftWins} - ${gameState.rightWins}) 🎉`;
                } else {
                    victoryMessage.textContent = `تهانينا للاعب الأيسر! (${gameState.leftWins} - ${gameState.rightWins}) 🏆`;
                }
            } else {
                victoryTitle.textContent = 'خسارة بالمباراة!';
                if (gameState.mode === 'single') {
                    victoryMessage.textContent = `لقد فاز الذكاء الاصطناعي بهذه المباراة! (${gameState.leftWins} - ${gameState.rightWins}) حاول مرة أخرى 🤖`;
                } else if (gameState.mode === 'online') {
                    victoryMessage.textContent = `لقد خسرت هذه المباراة! (${gameState.leftWins} - ${gameState.rightWins}) حاول مرة أخرى 😢`;
                } else {
                    victoryMessage.textContent = `تهانينا للاعب الأيمن! (${gameState.leftWins} - ${gameState.rightWins}) 🏆`;
                }
            }
            
            showScreen('victoryScreen');
        }

        function showFinalVictory() {
            const victoryTitle = document.getElementById('victoryTitle');
            const victoryMessage = document.getElementById('victoryMessage');
            const victoryScore = document.getElementById('victoryScore');
            const continueBtn = document.getElementById('continueBtn');
            
            victoryScore.textContent = `النتيجة النهائية: ${gameState.leftWins} - ${gameState.rightWins} انتصارات`;
            continueBtn.textContent = 'لعبة جديدة';
            continueBtn.onclick = () => {
                if (gameState.isOnline) {
                    showScreen('onlineLobby');
                } else {
                    startGame(gameState.mode);
                }
            };
            
            if (gameState.leftWins > gameState.rightWins) {
                victoryTitle.textContent = 'فوز نهائي! 🏆';
                if (gameState.mode === 'single') {
                    victoryMessage.textContent = 'مبروك! لقد هزمت الذكاء الاصطناعي وحققت الفوز النهائي! 🎉🎉🎉';
                } else if (gameState.mode === 'online') {
                    victoryMessage.textContent = 'مبروك! لحققت الفوز النهائي في اللعب الأونلاين! 🎉🎉🎉';
                } else {
                    victoryMessage.textContent = 'تهانينا للاعب الأيسر على الفوز النهائي! 🏆🏆🏆';
                }
            } else {
                victoryTitle.textContent = 'خسارة نهائية! 😢';
                if (gameState.mode === 'single') {
                    victoryMessage.textContent = 'لقد فاز الذكاء الاصطناعي باللعبة النهائية! حاول مرة أخرى 🤖💔';
                } else if (gameState.mode === 'online') {
                    victoryMessage.textContent = 'لقد خسرت اللعبة النهائية! حاول مرة أخرى 😢💔';
                } else {
                    victoryMessage.textContent = 'تهانينا للاعب الأيمن على الفوز النهائي! 🏆🏆🏆';
                }
            }
            
            showScreen('victoryScreen');
        }

        function continueGame() {
            gameState.leftScore = 0;
            gameState.rightScore = 0;
            gameState.paused = false;
            gameState.running = true;
            
            ball.reset();
            
            updateScoreDisplay();
            updateWinsDisplay();
            
            showScreen('gameScreen');
            
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            
            showToast('بدأت مباراة جديدة!');
        }

        function endGame() {
            gameState.running = false;
            if (gameState.isOnline) {
                onlineManager.disconnect();
                showScreen('onlineLobby');
            }
        }

        function restartGame() {
            if (gameState.isOnline) {
                startOnlineGame();
            } else {
                startGame(gameState.mode);
            }
        }

        function togglePause() {
            gameState.paused = !gameState.paused;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.innerHTML = gameState.paused ? 
                '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>' :
                '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14 19h4V5h-4m-6 14h4V5H8v14z"/></svg>';
            
            if (gameState.paused) {
                showToast('اللعبة متوقفة');
            }
        }

        // ===== UI FUNCTIONS =====
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function updateScoreDisplay() {
            document.getElementById('scoreDisplay').textContent = 
                `${gameState.leftScore} : ${gameState.rightScore}`;
        }

        function updateWinsDisplay() {
            document.getElementById('winsDisplay').textContent = 
                `الانتصارات: ${gameState.leftWins} - ${gameState.rightWins}`;
        }

        function updateSoundButton() {
            const soundBtn = document.getElementById('soundBtn');
            soundBtn.innerHTML = gameState.soundEnabled ? 
                '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>' :
                '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>';
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            updateSoundButton();
            Storage.save();
            showToast(gameState.soundEnabled ? 'الصوت مفعل' : 'الصوت معطل');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // ===== SETTINGS FUNCTIONS =====
        function setDifficulty(difficulty) {
            gameState.difficulty = difficulty;
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (ai) {
                ai.difficulty = difficulty;
                ai.speed = ai.getSpeed();
                ai.errorMargin = ai.getErrorMargin();
                ai.predictionAccuracy = ai.getPredictionAccuracy();
            }
            
            Storage.save();
            showToast(`تم ضبط الصعوبة على ${difficulty === 'easy' ? 'سهل' : difficulty === 'medium' ? 'متوسط' : 'صعب'}`);
        }

        function updateSettings() {
            gameState.winScore = parseInt(document.getElementById('winScore').value);
            gameState.gameSpeed = parseFloat(document.getElementById('gameSpeed').value);
            gameState.soundEnabled = document.getElementById('soundEnabled').checked;
            gameState.vibrationEnabled = document.getElementById('vibrationEnabled').checked;
            gameState.showFps = document.getElementById('showFps').checked;
            gameState.tiltControl = document.getElementById('tiltControl').checked;
            
            updateSoundButton();
            document.getElementById('fpsCounter').classList.toggle('show', gameState.showFps);
            
            Storage.save();
            showToast('تم حفظ الإعدادات');
        }

        function applySettings() {
            document.getElementById('winScore').value = gameState.winScore;
            document.getElementById('gameSpeed').value = gameState.gameSpeed;
            document.getElementById('soundEnabled').checked = gameState.soundEnabled;
            document.getElementById('vibrationEnabled').checked = gameState.vibrationEnabled;
            document.getElementById('showFps').checked = gameState.showFps;
            document.getElementById('tiltControl').checked = gameState.tiltControl;
            document.getElementById('darkMode').checked = gameState.darkMode;
            
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(gameState.difficulty)) {
                    btn.classList.add('active');
                }
            });
            
            if (gameState.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            updateSoundButton();
            document.getElementById('fpsCounter').classList.toggle('show', gameState.showFps);
        }

        function resetSettings() {
            if (confirm('هل أنت متأكد من إعادة التعيين؟')) {
                gameState.difficulty = CONSTANTS.DEFAULT_DIFFICULTY;
                gameState.winScore = CONSTANTS.DEFAULT_WIN_SCORE;
                gameState.gameSpeed = CONSTANTS.DEFAULT_GAME_SPEED;
                gameState.soundEnabled = CONSTANTS.DEFAULT_SOUND_ENABLED;
                gameState.vibrationEnabled = CONSTANTS.DEFAULT_VIBRATION_ENABLED;
                gameState.showFps = CONSTANTS.DEFAULT_SHOW_FPS;
                gameState.tiltControl = CONSTANTS.DEFAULT_TILT_CONTROL;
                gameState.darkMode = CONSTANTS.DEFAULT_DARK_MODE;
                
                applySettings();
                Storage.save();
                showToast('تم إعادة التعيين إلى الافتراضي');
            }
        }

        function toggleTheme() {
            gameState.darkMode = document.getElementById('darkMode').checked;
            if (gameState.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            Storage.save();
        }

        // ===== HELPER FUNCTIONS =====
        function playSound(type) {
            if (audio) {
                audio.playSound(type);
            }
        }

        // ===== INIT ON LOAD =====
        window.addEventListener('load', init);
    </script>
</body>
</html>
